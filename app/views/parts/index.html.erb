<!-- app/views/parts/index.html.erb -->
<h1 class="mb-4">Parts List</h1>

<div class="mb-3">
  <input type="text" id="search" class="form-control" placeholder="Search parts...">
</div>

<div class="mb-3">
  <h5>Make</h5>
  <%= select_tag "q[model_make_id_eq]", options_from_collection_for_select(Make.all, :id, :name, { include_blank: true }), class: 'form-control' %>
</div>

<div class="mb-3">
  <h5>Model</h5>
  <%= select_tag "q[model_id_eq]", options_from_collection_for_select(Model.all, :id, :name, { include_blank: true }), class: 'form-control' %>
</div>

<div class="mb-3">
  <h5>Year</h5>
  <%= select_tag "q[year_id_eq]", options_from_collection_for_select(Year.all, :id, :year, { include_blank: true }), class: 'form-control' %>
</div>

<div class="mb-3">
  <h5>Price Range</h5>
  <select id="filter-price" class="form-control">
    <option value="">Select Price Range</option>
    <option value="0-100">0 - 100</option>
    <option value="101-200">101 - 200</option>
    <option value="201-300">201 - 300</option>
    <option value="301-400">301 - 400</option>
    <option value="401-500">401 - 500</option>
  </select>
</div>

<div class="mb-3">
  <%= form_with url: import_parts_path, local: true, method: :post, html: { multipart: true } do %>
    <%= file_field_tag :file %>
    <%= submit_tag 'Import Parts', class: 'btn btn-primary' %>
  <% end %>
</div>

<div class="mb-3">
  <%= link_to 'Export Parts', export_parts_path, class: 'btn btn-success' %>
  <%= link_to 'Download Export', download_export_parts_path, class: 'btn btn-info' %>
</div>

<% if flash[:alert] %>
  <div class="alert alert-danger"><%= flash[:alert] %></div>
<% end %>
<% if flash[:notice] %>
  <div class="alert alert-success"><%= flash[:notice] %></div>
<% end %>

<div id="part-list" class="table-responsive">
  <table class="table table-striped">
    <tbody>
      <%= render partial: 'parts/part_list', locals: { parts: @parts } %>
    </tbody>
  </table>
</div>

<div class="my-3">
  <%= link_to 'New Part', new_part_path, class: 'btn btn-success' %>
  <%= link_to 'Order List', orders_path, class: 'btn btn-secondary' %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search');
    const priceFilter = document.getElementById('filter-price');
    const makeFilter = document.querySelector('select[name="q[model_make_id_eq]"]');
    const modelFilter = document.querySelector('select[name="q[model_id_eq]"]');
    const yearFilter = document.querySelector('select[name="q[year_id_eq]"]');

    const fetchParts = () => {
      const query = searchInput.value;
      const priceRange = priceFilter.value;
      const makeId = makeFilter.value;
      const modelId = modelFilter.value;
      const yearId = yearFilter.value;

      // Construct the query string
      let url = `/parts/search?q[item_part_number_or_part_number_or_name_or_description_cont]=${query}`;
      if (makeId) {
        url += `&q[model_make_id_eq]=${makeId}`;
      }
      if (modelId) {
        url += `&q[model_id_eq]=${modelId}`;
      }
      if (yearId) {
        url += `&q[year_id_eq]=${yearId}`;
      }
      if (priceRange) {
        const [minPrice, maxPrice] = priceRange.split('-');
        url += `&q[price_gteq]=${minPrice}&q[price_lteq]=${maxPrice}`;
      }

      fetch(url)
        .then(response => response.text())
        .then(html => {
          document.getElementById('part-list').innerHTML = html;
        });
    };

    searchInput.addEventListener('input', fetchParts);
    priceFilter.addEventListener('change', fetchParts);
    makeFilter.addEventListener('change', fetchParts);
    modelFilter.addEventListener('change', fetchParts);
    yearFilter.addEventListener('change', fetchParts);
  });
</script>